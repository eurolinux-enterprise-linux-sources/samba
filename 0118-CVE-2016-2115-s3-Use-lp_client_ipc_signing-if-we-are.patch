From d202c8094f9de900dd2e8fda50439cc516ae8fc2 Mon Sep 17 00:00:00 2001
From: Andreas Schneider <asn@samba.org>
Date: Tue, 5 Apr 2016 10:46:53 +0200
Subject: [PATCH 118/321] CVE-2016-2115: s3: Use lp_client_ipc_signing() if we
 are not an smb client

BUG: https://bugzilla.samba.org/show_bug.cgi?id=11756

Pair-Programmed-With: Ralph Boehme <slow@samba.org>
Signed-off-by: Andreas Schneider <asn@samba.org>
Signed-off-by: Ralph Boehme <slow@samba.org>
---
 source3/param/loadparm.c                    | 14 ++++++++++++++
 source3/rpc_server/spoolss/srv_spoolss_nt.c |  2 +-
 2 files changed, 15 insertions(+), 1 deletion(-)

diff --git a/source3/param/loadparm.c b/source3/param/loadparm.c
index a612e5a3898..c58f8608094 100644
--- a/source3/param/loadparm.c
+++ b/source3/param/loadparm.c
@@ -9712,6 +9712,20 @@ static bool lp_load_ex(const char *pszFname,
 		lp_do_parameter(GLOBAL_SECTION_SNUM, "wins server", "127.0.0.1");
 	}
 
+	if (!lp_is_in_client()) {
+		switch (lp_client_ipc_signing()) {
+		case Required:
+			lp_set_cmdline("client signing", "mandatory");
+			break;
+		case Auto:
+			lp_set_cmdline("client signing", "auto");
+			break;
+		case False:
+			lp_set_cmdline("client signing", "disabled");
+			break;
+		}
+	}
+
 	init_iconv();
 
 	bAllowIncludeRegistry = true;
diff --git a/source3/rpc_server/spoolss/srv_spoolss_nt.c b/source3/rpc_server/spoolss/srv_spoolss_nt.c
index 181a7b5dbdf..a0fcf27a3ed 100644
--- a/source3/rpc_server/spoolss/srv_spoolss_nt.c
+++ b/source3/rpc_server/spoolss/srv_spoolss_nt.c
@@ -2480,7 +2480,7 @@ static bool spoolss_connect_to_client(struct rpc_pipe_client **pp_pipe,
 		"", /* username */
 		"", /* domain */
 		"", /* password */
-		0, lp_client_signing());
+		0, False);
 
 	if ( !NT_STATUS_IS_OK( ret ) ) {
 		DEBUG(2,("spoolss_connect_to_client: connection to [%s] failed!\n",
-- 
2.14.3

